### bitrix_server
=========
##### Description
-----------------

Роль создает все необходимое окружение для **CMS Bitrix**. 
Компоненты:
* nginx
* httpd
* php-fpm
* mariadb
* push-server
* memcached
* redis
* Дополнительное ПО для прохождения проверок Bitrix

Дополнительные репозитории:
* Epel
* Remi
* MariaDB
* Bitrix

Дополнительно в каталог /etc/ansible/roles копируется роль manage_sites, которая:
* создает конфиги nginx,httpd 
* Для Mysql создает бд и пользователя 
* директорию где будет размещаеться сайт
* копирует файлы для установки Bitrix и сразу указывает в них реквизиты БД для полуавтоматической установки CMS

В каталоге /etc/ansible/roles/manage_sites/files лежит скрипт обертка для этой роли add_sites.sh
Это скрипт принимает доменное имя и на основе него создает все необходимое.

##### Role Variables
--------------

###### PHP
В переменной **php_version** хранится версия php которая будет установлена на сервере. Пакеты ставятся из репозитория remi. 
Доступны версии: 
* 5.6 
* 7.0 
* 7.1 
* 7.2 
* 7.3 
* 7.4

В списке **php_packages** можно указать дополнительные расширения php.

###### MariaDB
**mariadb_user** - пользователь который будет создан при накатывании роли
**mariadb_user_pass** - пароль для этого пользователя
**mariadb_db** - база данных


##### Example Playbook
----------------

Файлы роли можно разместить в:
* ./roles
* ~/.ansible/roles
* /etc/ansible/roles

Для тестирования роли создайте файл inventory, например:
```
[all]
node1.example.com
```

Далее создайте yml файл следующего содежания:
```
---
- hosts: node1.example.com
  remote_user: root
  roles:
    - bitrix_server
```

###### Запуск установки

`ansible-playbook -i inventory file.yml`

P.S. **Не забудьте закинуть свой ключ на сервер**

##### После того как роль установлена
-------
После того как **ansible** отработает, установка Bitrix доступна по URL которое получается из значения **{{ ansible_facts['nodename'] }}**
В контексте хостинга TimeWeb это URL вида **http://vdsid-yourlogin.tmweb.ru/**

Если Вы используете **Bitrix Управление сайтом**, то после установки CMS никаких дополнительных настроек не потребуется. Проверка будет проходить без ошибок.
Если Вы используете **Bitrix24**, то чтобы Bitrix проходил все проверки необходимо после установки CMS сделать:
1. В настройках главного модуля включить:
  * Быстрая отдача файлов через Nginx
2. В списке модулей удалить:
  * Компрессия (compression)
3. В настройках модуля Push and Pull указать:
  * Использовать "Push server": Использовать сервер, установленный локально
  * На сервер установлена: Виртуальная машина 7.1 - 7.2 (Bitrix Push server 1.0) 
  * Код-подпись для взаимодействия с сервером: 
Данный код можно получить из переменной SECURITY_KEY с помощью команды
`grep SECURITY_KEY /etc/sysconfig/push-server-multi`

##### License
-------

Free

##### Author Information
------------------

Kobylkin Konstantin. EPAM DevOps Winter 2019