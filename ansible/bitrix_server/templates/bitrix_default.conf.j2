server {
  listen {{ ansible_facts['default_ipv4']['address'] }}:80 default_server;
  
  server_name _;
  
  access_log /var/log/nginx/default_access.log main;
  error_log  /var/log/nginx/default_error.log;

  server_name_in_redirect off;

  gzip on;
  gzip_comp_level 5;
  gzip_disable "msie6";
  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

  proxy_set_header	X-Real-IP $remote_addr;
  proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header	Host $host:80;

  set $proxyserver	"http://127.0.0.1:8080";
  set $docroot	"/var/www/{{ ansible_facts['nodename'] }}";

  index index.php;
  root "/var/www/{{ ansible_facts['nodename'] }}";
  proxy_ignore_client_abort off;

# Redirect to ssl if need
  if (-f /var/www/{{ ansible_facts['nodename'] }}/.htsecure) { rewrite ^(.*)$ https://$host$1 permanent; }

  location / {
    proxy_pass $proxyserver;
  }

  location ~ \.php$ {
    proxy_pass $proxyserver;
  }

  location ~ /$ {
    proxy_pass $proxyserver;
  }


}